(function(){var a=angular.module("homer.cflow",[]);a.factory("$homerCflow",["$rootScope","$controller","$location","$timeout","$compile","$sniffer","$q","$filter",homer.modules.core.services.profile,function(m,g,l,w,s,v,r,p,f){var n={};var x,q,b,h,k,d,e,u,j,i,t;var c;q=function(A,z){var y;z.beginPath();z.lineCap="round";z.strokeStyle=A.Color;z.lineWidth=A.LineWidth;z.moveTo(A.Points[0].x,A.Points[0].y);for(y=0;y<A.Points.length;y++){z.lineTo(A.Points[y].x,A.Points[y].y)}z.stroke()};b=function(y){c.beginPath();c.strokeStyle=y.LineColor;c.lineWidth=y.LineWidth;c.lineCap="round";c.moveTo(y.StartX,y.StartY);c.lineTo(y.EndX,y.EndY);c.stroke()};u=function(B){c.beginPath();c.strokeStyle=B.LineColor;c.lineWidth=B.LineWidth;c.lineCap="round";c.moveTo(B.StartX,B.StartY);c.lineTo(B.EndX,B.EndY);var A=10;var z=B.EndX-B.StartX;var y=B.EndY-B.StartY;var C=Math.atan2(y,z);c.moveTo(B.StartX,B.StartY);c.lineTo(B.EndX,B.EndY);c.lineTo(B.EndX-A*Math.cos(C-Math.PI/6),B.EndY-A*Math.sin(C-Math.PI/6));c.moveTo(B.EndX,B.EndY);c.lineTo(B.EndX-A*Math.cos(C+Math.PI/6),B.EndY-A*Math.sin(C+Math.PI/6));c.stroke()};e=function(y){c.beginPath();c.fillStyle=y.TextColor;c.font=y.Font;c.textAlign=y.textAlign;c.fillText(y.Text,y.StartX,y.StartY);c.stroke()};j=function(y){c.strokeStyle=y.TextColor;c.font=y.Font;return c.measureText(y.Text)};i=function(z){c.beginPath();var y=new Image();y.src=z.ImageSrc;y.onload=function(){c.drawImage(y,z.StartX,z.StartY);c.stroke()}};h=function(z,y){y.beginPath();y.strokeStyle=z.LineColor;y.fillStyle=z.FillColor;y.lineWidth=z.LineWidth;y.rect(z.StartX,z.StartY,z.Width,z.Height);if(z.FillShape){y.fill()}y.stroke()};k=function(z,y){y.beginPath();y.strokeStyle=z.LineColor;y.fillStyle=z.FillColor;y.lineWidth=z.LineWidth;y.arc(z.StartX,z.StartY,z.Radius,0,Math.PI*2,false);if(z.FillShape){y.fill()}y.stroke()};t=function(z){var A=0;for(var y=0;y<z.length;y++){A=z.charCodeAt(y)+((A<<5)-A)}return"hsl("+((A>>24)&255)+", 75%, 35%)"};var o={waitingForOpen:false,getOpenedModals:function(){return openedModals},register:function(y){n[y.id||"_default"]=y},remove:function(y){delete n[y||"_default"]},setContext:function(F,S){var I=f.getProfile("timezone");var D=[];var B=angular.element(document.querySelectorAll("#"+F));var z=$(B).find("#cflowcanv");var J=z[0].getContext("2d");c=J;var y=50;var E=$(B).height()-110;var H=$(B).width()-20;var N=S.calldata.length;N+=3;if((N*y)>E){E=N*y}J.canvas.width=H;J.canvas.height=E;var A={};var Q={};var R={width:0};J.clearRect(0,0,c.canvas.width,c.canvas.height);J.fillStyle="#FFF";J.opacity=0.2;J.fillRect(0,0,c.canvas.width,c.canvas.height);H-=20;E-=30;var C=Object.keys(S.hosts).length-1;var G=H/(C?C:1);var L=Object.keys(S.hosts).length;angular.forEach(S.hosts,function(W,V){var Y=parseInt(W.position);Q={};Q.LineColor="#000";Q.LineWidth=1;Q.StartX=Y*G+10;Q.StartY=65;Q.EndX=Y*G+10;Q.EndY=E;b(Q);A[V]=Q;Q={};Q.TextColor="#666666";Q.Text=V;Q.Font="normal 11px Arial";Q.textAlign="start";Q.StartY=60;if(myFlowStyle){Q.TextColor=myFlowStyle.hosts.drawdata.TextColor;Q.Font=myFlowStyle.hosts.drawdata.Font;Q.LineColor=myFlowStyle.hosts.drawdata.LineColor;Q.LineWidth=myFlowStyle.hosts.drawdata.LineWidth}R=j(Q);var U=Y*G-(R.width/2)+10;var X=Y*G-20;if(Y==0){U=Y*G;X=Y*G}else{if(Y==(L-1)){U=(Y*G)-R.width+15;X=Y*G-30}}Q.StartX=U;e(Q);D.push({x1:Q.StartX,y1:Q.StartY-10,x2:Q.StartX+R.width,y2:Q.StartY+10,type:"host"});var Z=S.uac[V];Q={};if(Z&&Z.image){Q.ImageSrc="/img/gateways/"+Z.image+".jpg"}else{Q.ImageSrc="/img/gateways/sipgateway.jpg"}if(Z&&Z.agent&&myUserAgents){for(var T=0;T<myUserAgents.length;T++){if(Z.agent.match(myUserAgents[T].rule)){Q.ImageSrc=myUserAgents[T].img}}}Q.StartY=2;Q.textAlign="start";Q.StartX=X;i(Q)});E-=130;var K=E/((S.calldata.length-1)?(S.calldata.length-1):1);if(K<50){K=50}var M=0,P,O;angular.forEach(S.calldata,function(T){if(A.hasOwnProperty(T.source_alias)){P=A[T.source_alias]}else{P=A[T.src_id]}if(A.hasOwnProperty(T.destination_alias)){O=A[T.destination_alias]}else{O=A[T.dst_id]}Q={};Q.LineColor="#000";if(myFlowStyle&&myFlowStyle.calldata.drawdata.ReColor){Q.LineColor=t(T.protocol+T.callid)}Q.LineWidth=1;Q.StartX=P.StartX;Q.StartY=M*K+110;Q.EndX=O.StartX;Q.EndY=M*K+110;u(Q);Q={};Q.TextColor=T.msg_color;Q.Text=T.protocol+": "+(M+1)+": "+T.method_text;Q.Font="12px Futura, Helvetica, Arial";R=j(Q);Q.StartY=M*K+107;if(P.StartX<O.StartX){Q.StartX=P.StartX+20}else{Q.StartX=P.StartX-R.width}Q.textAlign="start";if(myFlowStyle){Q.Font=myFlowStyle.calldata.drawdata.Font}e(Q);D.push({x1:Q.StartX-10,y1:Q.StartY-10,x2:Q.StartX+R.width,y2:Q.StartY+10,type:"message",data:T});Q={};Q.TextColor="#C0C0C0";Q.Text=p("date")(new Date(T.micro_ts/1000),"yyyy-MM-dd HH:mm:ss.sss Z",I.offset);Q.Font="lighter 8pt Arial";Q.textAlign="start";R=j(Q);Q.StartY=M*K+122;if(P.StartX<O.StartX){Q.StartX=P.StartX+20}else{Q.StartX=P.StartX-20-R.width}M++;e(Q)});return D}};return o}]).directive("canvasclick",["$homerModal",function(b){return{restrict:"EA",link:function(e,d,c){d.on("click",function(f){e.clickMousePosition(f)});d.on("mousemove",function(g,f){if(e.checkMousePosition(g)){d.context.style.cursor="pointer"}else{d.context.style.cursor="default"}})}}}])})();